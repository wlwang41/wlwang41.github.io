<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
        <title>POST发送数据方式 - crow coffin</title>
        <meta name="keywords" content="python web"/>
        <meta name="description" content="Learning in the hard way."/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body>
        <div id="header">
            <ul>
                <li>
                    <a href="/" style="color: wheat;border-right: solid 1px gray;">crow coffin</a>
                </li>
                <li>
                    <a href="https://github.com/wlwang41" target="_blank">my github</a>
                </li>
                <li>
                    <a href="http://about.me/wlwang41" target="_blank">about.me</a>
                </li>
                <li>
                    <a href="http://aboutcrow.herokuapp.com/" target="_blank">resume</a>
                </li>
                <li>
                    <a href="mailto:wlwang41@gmail.com">email</a>
                </li>
            </ul>
        </div>
        <div id="container">
            
    <div id="content_header">
        <div id="post-nav">
            
            <a href="/">Home</a> » <a href="/#http">http</a> » POST发送数据方式
            
        </div>
    </div>
    <div class="clearfix"></div>
    <div id="title">POST发送数据方式</div>
    <div id="content">
        <p>POST方法发送数据的方式有2种，一种是 <code>application/x-www-form-urlencoded</code>, 另外一种就是 <code>multipart/form-data</code> .</p>
<h2 id="applicationx-www-form-urlencoded">application/x-www-form-urlencoded</h2>
<p>对于这种方式，传输给服务端的HTTP的body的信息是一个巨大的字符串，就像：</p>
<div class="hlcode"><pre><span class="err">☁</span>  <span class="o">~</span>  <span class="n">curl</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">d</span> <span class="s">&quot;fizz=buzz&amp;buzz=fizz&quot;</span> <span class="n">http</span><span class="o">:</span><span class="c1">//requestb.in/1e8sq8a1</span>
<span class="o">*</span> <span class="n">Hostname</span> <span class="n">was</span> <span class="n">NOT</span> <span class="n">found</span> <span class="n">in</span> <span class="n">DNS</span> <span class="n">cache</span>
<span class="o">*</span>   <span class="n">Trying</span> <span class="mf">50.16.239.160</span><span class="p">...</span>
<span class="o">*</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">requestb</span><span class="p">.</span><span class="n">in</span> <span class="p">(</span><span class="mf">127.0.0.1</span><span class="p">)</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="err">#</span><span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">POST</span> <span class="o">/</span><span class="mf">1e8</span><span class="n">sq8a1</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="o">&gt;</span> <span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">curl</span><span class="o">/</span><span class="mf">7.37.1</span>
<span class="o">&gt;</span> <span class="n">Host</span><span class="o">:</span> <span class="n">requestb</span><span class="p">.</span><span class="n">in</span>
<span class="o">&gt;</span> <span class="n">Accept</span><span class="o">:</span> <span class="err">*/</span><span class="o">*</span>
<span class="o">&gt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">19</span>
<span class="o">&gt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span>
<span class="o">&gt;</span>
<span class="o">*</span> <span class="n">upload</span> <span class="n">completely</span> <span class="n">sent</span> <span class="n">off</span><span class="o">:</span> <span class="mi">19</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">19</span> <span class="n">bytes</span>
<span class="o">&lt;</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="o">&lt;</span> <span class="n">Connection</span><span class="o">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="o">*</span> <span class="n">Server</span> <span class="n">gunicorn</span><span class="o">/</span><span class="mf">18.0</span> <span class="n">is</span> <span class="n">not</span> <span class="n">blacklisted</span>
<span class="o">&lt;</span> <span class="n">Server</span><span class="o">:</span> <span class="n">gunicorn</span><span class="o">/</span><span class="mf">18.0</span>
<span class="o">&lt;</span> <span class="n">Date</span><span class="o">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mi">26</span> <span class="n">Nov</span> <span class="mi">2014</span> <span class="mi">14</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">14</span> <span class="n">GMT</span>
<span class="o">&lt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<span class="o">&lt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">2</span>
<span class="o">&lt;</span> <span class="n">Sponsored</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.runscope.com</span>
<span class="o">&lt;</span> <span class="n">Via</span><span class="o">:</span> <span class="mf">1.1</span> <span class="n">vegur</span>
<span class="o">&lt;</span>
<span class="o">*</span> <span class="n">Connection</span> <span class="err">#</span><span class="mi">0</span> <span class="n">to</span> <span class="n">host</span> <span class="n">requestb</span><span class="p">.</span><span class="n">in</span> <span class="n">left</span> <span class="n">intact</span>
<span class="n">ok</span><span class="o">%</span>
</pre></div>


<p>这里request的 <code>Content-Type</code> 就是 <code>application/x-www-form-urlencoded</code> .
这种方式对于要传输的巨大的字符串中是有键值对构成，键和值之间由 <code>=</code> 隔开，每组键值对之间由 <code>&amp;</code> 隔开.
但是这种这方式对于数据有一定的要求：</p>
<ul>
<li>空格将会被替换成 <code>+</code> </li>
<li>所有非字母数字的字符将会被替换成 <code>%HH</code> ，也就是一个百分号和2个16进制的值来代表该字符的ASCII码</li>
<li>折行将会被替换成 <code>CR LF</code> ( <code>%0D%0A</code> )</li>
</ul>
<p>由于有这样的规则，每一个非字母数字的字节将会被替换成3个字节，对于大的二级制文件，3倍的数据负载显得非常没有效率.</p>
<p>所以对于传输文件，非ASCII的数据，以及二级制的数据，就得用 <code>multipart/form-data</code></p>
<h2 id="multipartform-data">multipart/form-data</h2>
<p>下面的例子可以看到，请求的 <code>Content-Type</code> 就是 <code>multipart/form-data</code> ，里面的每组数据由 <code>boundary</code> 隔开.</p>
<div class="hlcode"><pre><span class="err">☁</span>  <span class="o">~</span>  <span class="n">curl</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">-</span><span class="n">F</span> <span class="s">&quot;fizz=buzz&amp;buzz=fizz&quot;</span> <span class="n">http</span><span class="o">:</span><span class="c1">//requestb.in/1e8sq8a1</span>
<span class="o">*</span> <span class="n">Hostname</span> <span class="n">was</span> <span class="n">NOT</span> <span class="n">found</span> <span class="n">in</span> <span class="n">DNS</span> <span class="n">cache</span>
<span class="o">*</span>   <span class="n">Trying</span> <span class="mf">50.16.239.160</span><span class="p">...</span>
<span class="o">*</span> <span class="n">Connected</span> <span class="n">to</span> <span class="n">requestb</span><span class="p">.</span><span class="n">in</span> <span class="p">(</span><span class="mf">127.0.0.1</span><span class="p">)</span> <span class="n">port</span> <span class="mi">80</span> <span class="p">(</span><span class="err">#</span><span class="mi">0</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">POST</span> <span class="o">/</span><span class="mf">1e8</span><span class="n">sq8a1</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="o">&gt;</span> <span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="o">:</span> <span class="n">curl</span><span class="o">/</span><span class="mf">7.37.1</span>
<span class="o">&gt;</span> <span class="n">Host</span><span class="o">:</span> <span class="n">requestb</span><span class="p">.</span><span class="n">in</span>
<span class="o">&gt;</span> <span class="n">Accept</span><span class="o">:</span> <span class="err">*/</span><span class="o">*</span>
<span class="o">&gt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">153</span>
<span class="o">&gt;</span> <span class="n">Expect</span><span class="o">:</span> <span class="mi">100</span><span class="o">-</span><span class="k">continue</span>
<span class="o">&gt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">boundary</span><span class="o">=------------------------</span><span class="n">f5926011c527fb7e</span>
<span class="o">&gt;</span>
<span class="o">&lt;</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">100</span> <span class="n">Continue</span>
<span class="o">&lt;</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="n">OK</span>
<span class="o">&lt;</span> <span class="n">Connection</span><span class="o">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
<span class="o">*</span> <span class="n">Server</span> <span class="n">gunicorn</span><span class="o">/</span><span class="mf">18.0</span> <span class="n">is</span> <span class="n">not</span> <span class="n">blacklisted</span>
<span class="o">&lt;</span> <span class="n">Server</span><span class="o">:</span> <span class="n">gunicorn</span><span class="o">/</span><span class="mf">18.0</span>
<span class="o">&lt;</span> <span class="n">Date</span><span class="o">:</span> <span class="n">Wed</span><span class="p">,</span> <span class="mi">26</span> <span class="n">Nov</span> <span class="mi">2014</span> <span class="mi">14</span><span class="o">:</span><span class="mi">26</span><span class="o">:</span><span class="mo">07</span> <span class="n">GMT</span>
<span class="o">&lt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
<span class="o">&lt;</span> <span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="o">:</span> <span class="mi">2</span>
<span class="o">&lt;</span> <span class="n">Sponsored</span><span class="o">-</span><span class="n">By</span><span class="o">:</span> <span class="n">https</span><span class="o">:</span><span class="c1">//www.runscope.com</span>
<span class="o">&lt;</span> <span class="n">Via</span><span class="o">:</span> <span class="mf">1.1</span> <span class="n">vegur</span>
<span class="o">&lt;</span>
<span class="o">*</span> <span class="n">Connection</span> <span class="err">#</span><span class="mi">0</span> <span class="n">to</span> <span class="n">host</span> <span class="n">requestb</span><span class="p">.</span><span class="n">in</span> <span class="n">left</span> <span class="n">intact</span>
<span class="n">ok</span><span class="o">%</span>
</pre></div>


<p>这种方式传输的数据，每一部分都是MIME的信息，没一部分由 <code>boundary</code> 字符串隔开，每一部分都可以有自己的MIME头信息，比如 <code>Content-Type</code> ，<code>Content-Disposition</code> 。
特别是 <code>Content-Disposition</code> ，这个头信息可以指定键值对中的键名，而键值对中的值就是MIME的信息主体。
通过w3c上的例子可以很清楚的理解这种协议：</p>
<div class="hlcode"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;http://server.com/cgi/handle&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;P&gt;</span>
        What is your name? <span class="nt">&lt;INPUT</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;submit-name&quot;</span><span class="nt">&gt;&lt;BR&gt;</span>
        What files are you sending? <span class="nt">&lt;INPUT</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span> <span class="na">name=</span><span class="s">&quot;files&quot;</span><span class="nt">&gt;&lt;BR&gt;</span>
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;INPUT</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Send&quot;</span><span class="nt">&gt;</span> <span class="nt">&lt;INPUT</span> <span class="na">type=</span><span class="s">&quot;reset&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>


<p>这里是一段表单提交的html代码，当用户在text的input标签中输入了Larry，在file的input标签中选择了file1.txt的时候，user agent将会回传这样的数据:</p>
<div class="hlcode"><pre><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">boundary</span><span class="o">=</span><span class="n">AaB03x</span>

<span class="o">--</span><span class="n">AaB03x</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="o">:</span> <span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;submit-name&quot;</span>

<span class="n">Larry</span>
<span class="o">--</span><span class="n">AaB03x</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="o">:</span> <span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;files&quot;</span><span class="p">;</span> <span class="n">filename</span><span class="o">=</span><span class="s">&quot;file1.txt&quot;</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span>

<span class="p">...</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">file1</span><span class="p">.</span><span class="n">txt</span> <span class="p">...</span>
<span class="o">--</span><span class="n">AaB03x</span><span class="o">--</span>
</pre></div>


<p>在 <code>Content-Type</code> 中指明数据传输的类型是 <code>multipart/form-data</code> ，并且boundary字符串为AaB03x。
每一部分MIME信息都有上面指定的边界字符串隔开，并且每一部分MIME信息都可以有自己的头，如 <code>Content-Disposition: form-data; name="submit-name"</code> ，表明submit-name字段的值为Larry。
如果传输的是文件，文件名可以通过 <code>Content-Disposition</code> 中的 <code>filename</code> 字段来指明。</p>
<p>如果在file的input标签里面又传了一张图片，那么user agent将会返回这样的数据：</p>
<div class="hlcode"><pre><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">boundary</span><span class="o">=</span><span class="n">AaB03x</span>

<span class="o">--</span><span class="n">AaB03x</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="o">:</span> <span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;submit-name&quot;</span>

<span class="n">Larry</span>
<span class="o">--</span><span class="n">AaB03x</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="o">:</span> <span class="n">form</span><span class="o">-</span><span class="n">data</span><span class="p">;</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;files&quot;</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">multipart</span><span class="o">/</span><span class="n">mixed</span><span class="p">;</span> <span class="n">boundary</span><span class="o">=</span><span class="n">BbC04y</span>

<span class="o">--</span><span class="n">BbC04y</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="o">:</span> <span class="n">file</span><span class="p">;</span> <span class="n">filename</span><span class="o">=</span><span class="s">&quot;file1.txt&quot;</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span>

<span class="p">...</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">file1</span><span class="p">.</span><span class="n">txt</span> <span class="p">...</span>
<span class="o">--</span><span class="n">BbC04y</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Disposition</span><span class="o">:</span> <span class="n">file</span><span class="p">;</span> <span class="n">filename</span><span class="o">=</span><span class="s">&quot;file2.gif&quot;</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="o">:</span> <span class="n">image</span><span class="o">/</span><span class="n">gif</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="o">:</span> <span class="n">binary</span>

<span class="p">...</span><span class="n">contents</span> <span class="n">of</span> <span class="n">file2</span><span class="p">.</span><span class="n">gif</span><span class="p">...</span>
<span class="o">--</span><span class="n">BbC04y</span><span class="o">--</span>
<span class="o">--</span><span class="n">AaB03x</span><span class="o">--</span>
</pre></div>


<p>多文件的情况，外层的 <code>Content-Type</code> 将会是 <code>multipart/mixed</code> 并且指定了不同文件之间的boundary字符串。</p>
<p><code>multipart/form-data</code> 可以解决非字母数字组成的大字符串的传输带来的3倍的负载，但是也不是说所有数据传输都应该用它。
因为对于一般的数据而言，大量的boundary字符也是一种性能浪费。
所以，如果你需要传输包含非字母数字字符的数据(二进制数据)，就用 <code>multipart/form-data</code> ，否则就用 <code>application/x-www-form-urlencoded</code> 。</p>
<blockquote>
<p>更多请参考<a href="http://www.ietf.org/rfc/rfc2388.txt">RFC2388</a>，以及<a href="http://www.w3.org/TR/html401/interact/forms.html#h-17.13.4">w3c上的解释</a></p>
</blockquote>
    </div>

        </div>
        <div id="footer">
            <span>
                Copyright © now-forever crow.
                Powered by <a href="https://github.com/wlwang41/cb" target="_blank">Cb</a>.
                UI by <a href="https://github.com/tankywoo/wiki.tankywoo.com">yasimple</a>
            </span>
        </div>
    </body>
</html>